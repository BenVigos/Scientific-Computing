name: Compile LaTeX

permissions:
  contents: write

on:
  push:
    branches:
      - main
    paths-ignore:
      - assignment_1/report/main.pdf

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true  # allows pushing changes

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v2
        with:
          root_file: assignment_1/report/main.tex
          
      - name: "Debug: list files"
        run: ls -R assignment_1/report
        
      - name: Commit PDF
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Collect PDFs created in the repo (safe against no matches)
          pdfs=()
          while IFS= read -r -d $'\0' f; do
            pdfs+=("$f")
          done < <(find . -type f -name "*.pdf" -print0)

          if [ ${#pdfs[@]} -eq 0 ]; then
            echo "No PDFs found, nothing to commit"
            exit 0
          fi

          # Stage the PDFs and commit only if there are changes
          git add "${pdfs[@]}"
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Auto-update PDF"
          git push
